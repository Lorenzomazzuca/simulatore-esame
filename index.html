<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulatore</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:#111827;
  color:white;
}

.app{
  max-width:500px;
  margin:auto;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}

.header{
  padding:20px;
  background:#1f2937;
  position:sticky;
  top:0;
}

h1{
  margin:0;
  font-size:20px;
}

.stats{
  font-size:14px;
  margin-top:8px;
}

.content{
  padding:20px;
  flex:1;
}

.question{
  font-size:18px;
  margin-bottom:15px;
}

.answers button{
  width:100%;
  padding:14px;
  margin:8px 0;
  border-radius:10px;
  border:none;
  font-size:15px;
  background:#374151;
  color:white;
}

.correct{
  background:#16a34a !important;
}

.wrong{
  background:#dc2626 !important;
}

.footer{
  padding:15px;
  background:#1f2937;
  display:flex;
  justify-content:space-between;
}

button.control{
  padding:10px 14px;
  border-radius:8px;
  border:none;
  background:#2563eb;
  color:white;
}

select{
  margin-top:10px;
  padding:8px;
  border-radius:8px;
  border:none;
}
.history{
  background:#0f172a;
  padding:10px;
  font-size:13px;
  border-radius:8px;
  margin-top:15px;
}
</style>
</head>

<body>

<div class="app">

<div class="header">
  <h1>Simulatore</h1>
  <div class="stats">
    Domanda <span id="current">1</span>/<span id="total">0</span> |
    Score: <span id="score">0</span>
  </div>

  <select id="sizeSelect">
    <option value="30">30 domande</option>
    <option value="50">50 domande</option>
    <option value="75">75 domande</option>
    <option value="100">100 domande</option>
    <option value="all" selected>Tutte</option>
  </select>
</div>

<div class="content">
  <div class="question" id="question">Caricamento...</div>
  <div class="answers" id="answers"></div>

  <div class="history" id="historyBox">
    <strong>Storico ultime 5:</strong>
    <div id="history"></div>
    <div id="average"></div>
  </div>
</div>

<div class="footer">
  <button class="control" onclick="prev()">⬅</button>
  <button class="control" onclick="next()">➡</button>
  <button class="control" onclick="finish()">Fine</button>
  <button class="control" onclick="restart()">↻</button>
</div>

</div>

<script>

let quiz=[];
let order=[];
let currentPos=0;
let selected={};
let history=JSON.parse(localStorage.getItem("history")||"[]");

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function restart(){
  currentPos=0;
  selected={};

  let size=document.getElementById("sizeSelect").value;
  let max=quiz.length;
  if(size!=="all"){
    max=Math.min(parseInt(size),quiz.length);
  }

  order=shuffle([...Array(quiz.length).keys()]).slice(0,max);
  render();
}

function render(){
  const total=order.length;
  document.getElementById("total").textContent=total;
  document.getElementById("current").textContent=currentPos+1;

  const qIndex=order[currentPos];
  const q=quiz[qIndex];

  document.getElementById("question").textContent=q.question;

  const box=document.getElementById("answers");
  box.innerHTML="";

  q.answers.forEach((ans,i)=>{
    const btn=document.createElement("button");
    btn.textContent=String.fromCharCode(65+i)+") "+ans;

    if(selected[qIndex]!==undefined){
      if(i===q.correct) btn.classList.add("correct");
      if(selected[qIndex]===i && i!==q.correct) btn.classList.add("wrong");
    }

    btn.onclick=()=>{
      selected[qIndex]=i;
      render();
      updateScore();
    };

    box.appendChild(btn);
  });

  updateScore();
  renderHistory();
}

function updateScore(){
  let s=0;
  Object.keys(selected).forEach(k=>{
    if(selected[k]===quiz[k].correct) s++;
  });
  document.getElementById("score").textContent=s;
}

function next(){
  if(currentPos<order.length-1){
    currentPos++;
    render();
  }
}

function prev(){
  if(currentPos>0){
    currentPos--;
    render();
  }
}

function finish(){
  let score=0;
  Object.keys(selected).forEach(k=>{
    if(selected[k]===quiz[k].correct) score++;
  });

  let total=order.length;
  let percent=Math.round((score/total)*100);

  history.unshift(percent);
  history=history.slice(0,5);
  localStorage.setItem("history",JSON.stringify(history));

  alert("Risultato: "+score+"/"+total+" ("+percent+"%)");

  renderHistory();
}

function renderHistory(){
  const h=document.getElementById("history");
  const avg=document.getElementById("average");

  if(history.length===0){
    h.innerHTML="Nessun risultato";
    avg.innerHTML="";
    return;
  }

  h.innerHTML=history.map(x=>x+"%").join(" | ");

  const media=Math.round(history.reduce((a,b)=>a+b,0)/history.length);
  avg.innerHTML="<strong>Media ultime "+history.length+": "+media+"%</strong>";
}

fetch("questions.json")
  .then(r=>r.json())
  .then(data=>{
    quiz=data;
    restart();
  })
  .catch(()=>{
    document.getElementById("question").textContent="Errore caricamento domande.";
  });

</script>

</body>
</html>
