<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulatore</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:#0f172a;
  color:white;
}

.app{
  max-width:500px;
  margin:auto;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}

header{
  padding:20px;
  background:#111827;
  text-align:center;
  font-size:20px;
  font-weight:600;
  border-bottom:1px solid #1f2937;
}

.section{
  flex:1;
  padding:20px;
  overflow-y:auto;
}

.hidden{ display:none; }

.question{
  font-size:18px;
  margin-bottom:15px;
}

.answers button{
  width:100%;
  padding:14px;
  margin:8px 0;
  border-radius:12px;
  border:none;
  font-size:15px;
  background:#1f2937;
  color:white;
}

.correct{ background:#16a34a !important; }
.wrong{ background:#dc2626 !important; }

.nav-buttons{
  display:flex;
  justify-content:space-between;
  margin-top:20px;
  gap:8px;
}

.nav-buttons button{
  flex:1;
  padding:12px;
  border:none;
  border-radius:10px;
  background:#2563eb;
  color:white;
  font-weight:600;
}

.stats-box{
  background:#1e293b;
  padding:15px;
  border-radius:12px;
  margin-bottom:15px;
}

.bottom-nav{
  display:flex;
  background:#111827;
  border-top:1px solid #1f2937;
}

.bottom-nav button{
  flex:1;
  padding:14px;
  border:none;
  background:none;
  color:#9ca3af;
  font-size:14px;
}

.bottom-nav button.active{
  color:white;
  font-weight:600;
}

select{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:none;
  margin-bottom:15px;
  background:#1f2937;
  color:white;
}
</style>
</head>

<body>

<div class="app">

<header>Simulatore</header>

<!-- ALLENAMENTO -->
<div class="section" id="trainSection">

<select id="sizeSelect">
  <option value="30">30 domande</option>
  <option value="50">50 domande</option>
  <option value="75">75 domande</option>
  <option value="100">100 domande</option>
  <option value="all" selected>Tutte</option>
</select>

<div class="stats-box">
  Domanda <span id="current">1</span>/<span id="total">0</span><br>
  Score: <span id="score">0</span>
</div>

<div class="question" id="question">Caricamento...</div>
<div class="answers" id="answers"></div>

<div class="nav-buttons">
  <button onclick="prev()">⬅</button>
  <button onclick="next()">➡</button>
  <button onclick="finish()">Fine</button>
  <button onclick="start()">Rimescola</button>
</div>

</div>

<!-- STORICO -->
<div class="section hidden" id="historySection">

<div class="stats-box">
  <strong>Ultime 5 simulazioni</strong>
  <div id="historyList" style="margin-top:10px;"></div>
</div>

<div class="stats-box">
  <strong>Media ultime 5</strong>
  <div id="averageBox" style="margin-top:10px;"></div>
</div>

<button style="width:100%;padding:12px;border:none;border-radius:10px;background:#dc2626;color:white;"
onclick="clearHistory()">Cancella storico</button>

</div>

<div class="bottom-nav">
  <button id="navTrain" class="active" onclick="showTrain()">Allenamento</button>
  <button id="navHistory" onclick="showHistory()">Storico</button>
</div>

</div>

<script>

let quiz=[];
let order=[];
let currentPos=0;
let selected={};
let history=JSON.parse(localStorage.getItem("history")||"[]");

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function start(){
  currentPos=0;
  selected={};

  let size=document.getElementById("sizeSelect").value;
  let max=quiz.length;
  if(size!=="all") max=Math.min(parseInt(size),quiz.length);

  order=shuffle([...Array(quiz.length).keys()]).slice(0,max);
  render();
}

function render(){
  const total=order.length;
  document.getElementById("total").textContent=total;
  document.getElementById("current").textContent=currentPos+1;

  const qIndex=order[currentPos];
  const q=quiz[qIndex];

  document.getElementById("question").textContent=q.question;

  const box=document.getElementById("answers");
  box.innerHTML="";

  q.answers.forEach((ans,i)=>{
    const btn=document.createElement("button");
    btn.textContent=String.fromCharCode(65+i)+") "+ans;

    if(selected[qIndex]!==undefined){
      if(i===q.correct) btn.classList.add("correct");
      if(selected[qIndex]===i && i!==q.correct) btn.classList.add("wrong");
    }

    btn.onclick=()=>{
      selected[qIndex]=i;
      render();
      updateScore();
    };

    box.appendChild(btn);
  });

  updateScore();
}

function updateScore(){
  let s=0;
  Object.keys(selected).forEach(k=>{
    if(selected[k]===quiz[k].correct) s++;
  });
  document.getElementById("score").textContent=s;
}

function next(){
  if(currentPos < order.length - 1){
    currentPos++;
    render();
  } else {
    finish();
  }
}

function prev(){
  if(currentPos>0){
    currentPos--;
    render();
  }
}

function finish(){
  let score=0;
  Object.keys(selected).forEach(k=>{
    if(selected[k]===quiz[k].correct) score++;
  });

  let total=order.length;
  let percent=Math.round((score/total)*100);

  history.unshift(percent);
  history=history.slice(0,5);
  localStorage.setItem("history",JSON.stringify(history));

  alert("Simulazione terminata!\n\nRisultato: "+score+"/"+total+" ("+percent+"%)");

  renderHistory();
}

function renderHistory(){
  const list=document.getElementById("historyList");
  const avg=document.getElementById("averageBox");

  if(history.length===0){
    list.innerHTML="Nessun risultato";
    avg.innerHTML="-";
    return;
  }

  list.innerHTML=history.map(x=>"• "+x+"%").join("<br>");
  const media=Math.round(history.reduce((a,b)=>a+b,0)/history.length);
  avg.innerHTML=media+"%";
}

function clearHistory(){
  localStorage.removeItem("history");
  history=[];
  renderHistory();
}

function showTrain(){
  document.getElementById("trainSection").classList.remove("hidden");
  document.getElementById("historySection").classList.add("hidden");
  document.getElementById("navTrain").classList.add("active");
  document.getElementById("navHistory").classList.remove("active");
}

function showHistory(){
  document.getElementById("trainSection").classList.add("hidden");
  document.getElementById("historySection").classList.remove("hidden");
  document.getElementById("navHistory").classList.add("active");
  document.getElementById("navTrain").classList.remove("active");
  renderHistory();
}

fetch("questions.json")
  .then(r=>r.json())
  .then(data=>{
    quiz=data;
    start();
  })
  .catch(()=>{
    document.getElementById("question").textContent="Errore caricamento domande.";
  });

</script>

</body>
</html>